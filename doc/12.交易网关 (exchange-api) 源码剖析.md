# ç¬¬åäºŒç« ï¼šäº¤æ˜“æŒ‡ä»¤ç¬¬ä¸€ç«™ï¼šç½‘å…³(`exchange-api`)æºç å‰–æ

## å¼•è¨€ï¼šä¸€æ¬¡ä¸‹å•è¯·æ±‚çš„å¥‡å¦™æ—…ç¨‹

åœ¨è¿‡å»çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä¸ºäº¤æ˜“æ‰€æ„å»ºäº†åšå®çš„ç”¨æˆ·ï¼ˆ`ucenter-api`ï¼‰å’Œèµ„äº§ï¼ˆ`wallet`ï¼‰ç³»ç»Ÿã€‚ç°åœ¨ï¼Œæˆ‘ä»¬ç»ˆäºç«™åœ¨äº†æ•´ä¸ªç³»ç»Ÿçš„å¿ƒè„å…¥å£â€”â€”**å¸å¸äº¤æ˜“**ã€‚å½“ç”¨æˆ·åœ¨å±å¹•å‰ï¼Œæ€€ç€æœŸå¾…æˆ–ç´§å¼ çš„å¿ƒæƒ…ï¼Œç‚¹å‡»â€œä¹°å…¥â€æˆ–â€œå–å‡ºâ€æŒ‰é’®æ—¶ï¼Œè¿™ä¸ªå°å°çš„åŠ¨ä½œæ˜¯å¦‚ä½•åœ¨åºå¤§çš„åç«¯ç³»ç»Ÿä¸­æ€èµ·æ³¢æ¾œçš„ï¼Ÿ

**`exchange-api` æœåŠ¡ï¼Œå°±æ˜¯è¿™æ®µå¥‡å¦™æ—…ç¨‹çš„ç¬¬ä¸€ç«™ã€‚**

å®ƒæ‰®æ¼”ç€**äº¤æ˜“æµç¨‹çš„é¦–å¸­åè°ƒå®˜**çš„è§’è‰²ã€‚å®ƒä¸å…³å¿ƒä¹°å•å’Œå–å•å¦‚ä½•ç›¸é‡ï¼ˆé‚£æ˜¯`exchange`æ’®åˆå¼•æ“çš„èŒè´£ï¼‰ï¼Œè€Œæ˜¯ä¸“æ³¨äºå¤„ç†æ‰€æœ‰æ¥è‡ªç”¨æˆ·çš„äº¤æ˜“æŒ‡ä»¤ã€‚å®ƒå°±åƒä¸€ä¸ªä¸¥æ ¼ã€é«˜æ•ˆçš„â€œäº¤æ˜“å—ç†å¤„â€ï¼Œå…¶æ ¸å¿ƒä½¿å‘½å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š

- **æ‰¿ä¸Š**ï¼šä½œä¸ºå‰ç«¯ç”¨æˆ·çš„ API ç»Ÿä¸€å…¥å£ï¼Œå¯¹äº¤æ˜“è¯·æ±‚è¿›è¡Œä¸¥æ ¼çš„å‚æ•°æ ¡éªŒå’Œå¤æ‚çš„ä¸šåŠ¡è§„åˆ™å®¡æŸ¥ã€‚
- **å¯ä¸‹**ï¼šç²¾å¿ƒç¼–æ’å¯¹ä¸‹æ¸¸æœåŠ¡çš„è°ƒç”¨ï¼ŒåŒ…æ‹¬**åŒæ­¥è°ƒç”¨`wallet`æœåŠ¡**æ¥å†»ç»“èµ„é‡‘ï¼Œä»¥åŠ**å¼‚æ­¥å‘é€æ¶ˆæ¯ç»™`exchange`æ’®åˆå¼•æ“**ï¼Œå®ŒæˆæŒ‡ä»¤çš„ä¼ é€’ã€‚
- **å…¼é¡¾æŸ¥è¯¢**ï¼šåŒæ—¶ï¼Œå®ƒä¹Ÿè´Ÿè´£æä¾›**è®¢å•å†å²**å’Œ**å¸‚åœºæ·±åº¦**ç­‰æŸ¥è¯¢ç±»æ¥å£ï¼Œä¸ºå‰ç«¯æä¾›æ•°æ®æ”¯æŒã€‚

æœ¬ç« ï¼Œæˆ‘ä»¬å°†ä»¥ä¸€æ¬¡ä¸‹å•è¯·æ±‚ä¸ºä¾‹ï¼Œæ·±å…¥`exchange-api`çš„æºç ï¼Œå®Œæ•´åœ°è¿½è¸ªä¸€ä¸ªäº¤æ˜“æŒ‡ä»¤çš„ç”Ÿå‘½å‘¨æœŸã€‚è¿™å°†æ˜¯ä¸€ä¸ªç»ä½³çš„èŒƒä¾‹ï¼Œå› ä¸ºå®ƒå®Œç¾åœ°ä¸²è”èµ·äº†æˆ‘ä»¬ä¹‹å‰å­¦è¿‡çš„ API æ¥å£è®¾è®¡ã€æœåŠ¡é—´ RPC è°ƒç”¨ã€æ•°æ®åº“äº‹åŠ¡å¤„ç†ä»¥åŠ Kafka å¼‚æ­¥æ¶ˆæ¯é€šä¿¡ç­‰æ‰€æœ‰æ ¸å¿ƒçŸ¥è¯†ç‚¹ã€‚

---

## æ¶æ„å®šä½ï¼šCQRS æ€æƒ³çš„å®Œç¾ä½“ç°

`exchange-api`çš„æ ¸å¿ƒå®šä½æ˜¯ï¼š**å¸å¸äº¤æ˜“çš„ç»Ÿä¸€ API å…¥å£å’Œä¸šåŠ¡æµç¨‹åè°ƒè€…**ã€‚å®ƒä¸æ ¸å¿ƒæ’®åˆå¼•æ“`exchange`çš„åˆ†ç¦»ï¼Œæ˜¯é«˜æ€§èƒ½äº¤æ˜“ç³»ç»Ÿæ¶æ„è®¾è®¡çš„ç²¾é«“æ‰€åœ¨ã€‚

```mermaid
graph TD
    subgraph "User Interface"
        Client["Web / App"]
    end

    subgraph "API Gateway Layer"
        Nginx
    end

    subgraph "Business Logic Layer"
        subgraph "exchange-api"
            EC["ExchangeController"]
            EOS["ExchangeOrderService"]
            WSF["WalletService Feign"]
        end
    end

    subgraph "Downstream Services"
        subgraph "wallet"
            WalletService["Wallet Service"]
        end
        subgraph "exchange"
            MatchingEngine["Matching Engine"]
        end
        Kafka["Kafka<br>exchange-order"]
        Redis["Redis<br>Market Data"]
        MySQL["MySQL<br>Order Data"]
    end

    Client --> Nginx
    Nginx -- "/exchange/*" --> EC
    EC -- "1.Process Order" --> EOS
    EOS -- "2.Freeze Balance (RPC)" --> WSF
    WSF --> WalletService
    EOS -- "3.Save Order" --> MySQL
    EC -- "4.Send to Match" --> Kafka
    EC -- "Query Market Depth" --> Redis
    EC -- "Query Order History" --> MySQL
    Kafka --> MatchingEngine
```

è¿™ç§æ¶æ„è®¾è®¡ï¼Œæ˜¯**CQRSï¼ˆCommand Query Responsibility Segregationï¼Œå‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»ï¼‰**æ€æƒ³çš„ç»å…¸ä½“ç°ã€‚å®ƒå°†æ”¹å˜ç³»ç»ŸçŠ¶æ€çš„â€œ**å‘½ä»¤**â€å’Œä¸æ”¹å˜çŠ¶æ€çš„â€œ**æŸ¥è¯¢**â€åœ¨é€»è¾‘ä¸Šï¼ˆç”šè‡³ç‰©ç†ä¸Šï¼‰å®Œå…¨åˆ†å¼€ï¼š

1.  **å‘½ä»¤ (Command) ä¾§**ï¼š

    - **èŒè´£**ï¼šå¤„ç†ä¸‹å• (`/order/add`)ã€æ’¤å• (`/order/cancel`) ç­‰å†™æ“ä½œã€‚
    - **ç‰¹ç‚¹**ï¼šæµç¨‹å¤æ‚ï¼Œæ¶‰åŠå¤šæœåŠ¡åä½œã€æ•°æ®åº“äº‹åŠ¡å’Œæ¶ˆæ¯å‘é€ã€‚
    - **æ ¸å¿ƒå…³æ³¨ç‚¹**ï¼š**æ•°æ®ä¸€è‡´æ€§**ï¼ˆèµ„é‡‘å†»ç»“ä¸è®¢å•åˆ›å»ºå¿…é¡»æ˜¯åŸå­æ“ä½œï¼‰å’Œ**å¯é æ€§**ï¼ˆè®¢å•æŒ‡ä»¤å¿…é¡»æˆåŠŸé€è¾¾æ’®åˆå¼•æ“ï¼‰ã€‚

2.  **æŸ¥è¯¢ (Query) ä¾§**ï¼š
    - **èŒè´£**ï¼šå¤„ç†è·å–ä¸ªäººè®¢å•å†å² (`/order/history`)ã€è·å–å¸‚åœºæ·±åº¦ (`/market/depth`) ç­‰è¯»æ“ä½œã€‚
    - **ç‰¹ç‚¹**ï¼šæµç¨‹ç®€å•ï¼Œé€šå¸¸ç›´æ¥è®¿é—®æ•°æ®åº“æˆ–ç¼“å­˜ã€‚
    - **æ ¸å¿ƒå…³æ³¨ç‚¹**ï¼š**æŸ¥è¯¢æ€§èƒ½**å’Œ**å“åº”é€Ÿåº¦**ã€‚ä¾‹å¦‚ï¼Œå¸‚åœºæ·±åº¦æ•°æ®ä¼šç›´æ¥ä» Redis é«˜é€Ÿç¼“å­˜ä¸­è¯»å–ï¼Œç»•å¼€æ‰€æœ‰å¤æ‚é€»è¾‘ã€‚

è¿™ç§åˆ†ç¦»å¸¦æ¥äº†å·¨å¤§çš„æ¶æ„ä¼˜åŠ¿ï¼š

- **é«˜å¯ç”¨æ€§**ï¼šé€šè¿‡ Kafka çš„å¼‚æ­¥è§£è€¦ï¼Œå³ä½¿åç«¯çš„æ’®åˆå¼•æ“`exchange`æš‚æ—¶å®•æœºæˆ–å¤„ç†ç¼“æ…¢ï¼Œ`exchange-api`ä¾ç„¶å¯ä»¥æ¥æ”¶ç”¨æˆ·çš„ä¸‹å•è¯·æ±‚å¹¶å°†å…¶å®‰å…¨åœ°å­˜å…¥ Kafka æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¿™ä¿è¯äº†ç”¨æˆ·çš„äº¤æ˜“æŒ‡ä»¤æ°¸è¿œä¸ä¼šä¸¢å¤±ï¼Œç³»ç»Ÿçš„â€œå…¥å£â€å§‹ç»ˆç•…é€šã€‚
- **æè‡´çš„å“åº”é€Ÿåº¦**ï¼š`exchange-api`åœ¨å°†è®¢å•å†™å…¥ Kafka åï¼Œå°±å¯ä»¥ç«‹å³å‘ç”¨æˆ·è¿”å›â€œä¸‹å•æˆåŠŸâ€çš„å“åº”ï¼Œæ— éœ€åŒæ­¥ç­‰å¾…æ¼«é•¿çš„æ’®åˆç»“æœã€‚è¿™æå¤§åœ°é™ä½äº† API æ¥å£çš„å“åº”æ—¶é—´ï¼Œä¸ºç”¨æˆ·å¸¦æ¥äº†ä¸æ»‘çš„äº¤æ˜“ä½“éªŒã€‚
- **ç‹¬ç«‹æ‰©å±•**ï¼šå‘½ä»¤ä¾§å’ŒæŸ¥è¯¢ä¾§çš„è´Ÿè½½ç‰¹æ€§ä¸åŒã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦ï¼Œç‹¬ç«‹åœ°å¯¹`exchange-api`çš„å®ä¾‹æ•°é‡è¿›è¡Œæ‰©å±•ï¼Œä»¥åº”å¯¹ä¸åŒçš„æµé‡å‹åŠ›ã€‚

---

## å‘½ä»¤ä¾§æ·±åº¦è¿½è¸ªï¼š/order/add æ¥å£çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ

`/order/add`æ˜¯`exchange-api`ä¸­æœ€æ ¸å¿ƒã€æœ€å¤æ‚çš„â€œå‘½ä»¤â€æ¥å£ã€‚è®©æˆ‘ä»¬è¿½è¸ªä¸€ä¸ªä¸‹å•è¯·æ±‚åœ¨è¿™é‡Œç»å†çš„å®Œæ•´æ—…ç¨‹ã€‚

```mermaid
sequenceDiagram
    participant C as Client
    participant EC as ExchangeController
    participant EOS as ExchangeOrderService
    participant Redis as Redis Cache
    participant Wallet as WalletService (Feign)
    participant DB as MySQL (Transactional)
    participant K as Kafka

    C->>+EC: POST /order/add (symbol, price, amount, ...)
    EC->>+Redis: 1. è·å–äº¤æ˜“å¯¹é…ç½® (e.g., ç²¾åº¦)
    Redis-->>-EC: è¿”å›é…ç½®
    EC->>EC: 2. æ‰§è¡Œå¤§é‡å‰ç½®æ ¡éªŒ (ç”¨æˆ·çŠ¶æ€, ä»·æ ¼èŒƒå›´, æ´»åŠ¨è§„åˆ™...)
    Note right of EC: æ­¤å¤„ä¸ºâ€œèƒ–Controllerâ€<br>ä¸šåŠ¡é€»è¾‘é›†ä¸­åœ°

    EC->>+EOS: addOrder(memberId, order)
    rect rgba(220, 220, 255, 0.5)
        note over EOS: @Transactional å¼€å§‹
        EOS->>EOS: 3. æ„å»ºè®¢å•å¯¹è±¡ (ç”ŸæˆorderId, è®¾ç½®çŠ¶æ€ä¸ºTRADING)
        EOS->>+Wallet: 4. freezeBalance(wallet, turnover)
        Note right of Wallet: åŒæ­¥RPCè°ƒç”¨<br>æ‰§è¡Œèµ„é‡‘å†»ç»“
        Wallet-->>-EOS: å†»ç»“æˆåŠŸ

        EOS->>+DB: 5. exchangeOrderRepository.saveAndFlush(order)
        Note right of DB: è®¢å•æ•°æ®æŒä¹…åŒ–<br>ç¡®ä¿äº‹åŠ¡æäº¤å‰åˆ·ç›˜
        DB-->>-EOS: ä¿å­˜æˆåŠŸ
        note over EOS: @Transactional æäº¤
    end
    EOS-->>-EC: è¿”å›MessageResult.success()

    EC->>K: 6. kafkaTemplate.send("exchange-order", orderJson)
    Note right of K: å¼‚æ­¥å‘é€æ¶ˆæ¯<br>é€šçŸ¥æ’®åˆå¼•æ“

    EC-->>-C: è¿”å›æˆåŠŸå“åº” (åŒ…å«orderId)
```

#### 1. â€œèƒ– Controllerâ€çš„æ ¡éªŒä¹‹é—¨

æ—…ç¨‹çš„ç¬¬ä¸€ç«™æ˜¯`OrderController`ã€‚é€šè¿‡åˆ†ææºç ï¼Œæˆ‘ä»¬å‘ç°è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„â€œ**èƒ– Controller**â€â€”â€”å®ƒæ‰¿æ‹…äº†æå…¶ç¹é‡çš„æ ¡éªŒèŒè´£ï¼Œå‡ ä¹æ‰€æœ‰çš„ä¸šåŠ¡è§„åˆ™åˆ¤æ–­éƒ½é›†ä¸­åœ¨è¿™é‡Œã€‚

**æºç è·¯å¾„: `exchange-api/src/main/java/com/bizzan/bitrade/controller/OrderController.java`**

```java
@RequestMapping("add")
public MessageResult addOrder(@SessionAttribute(SESSION_MEMBER) AuthMember authMember,
                                ExchangeOrderDirection direction, String symbol, BigDecimal price,
                                BigDecimal amount, ExchangeOrderType type) {

    // é˜¶æ®µä¸€ï¼šåŸºç¡€æ ¡éªŒ
    Member member = memberService.findOne(authMember.getId());
    if(member.getTransactionStatus().equals(BooleanEnum.IS_FALSE)){
        return MessageResult.error(500, msService.getMessage("CANNOT_TRADE"));
    }

    // é˜¶æ®µäºŒï¼šäº¤æ˜“å¯¹é…ç½®æ ¡éªŒ (åº”ä¼˜å…ˆä»Redisè·å–)
    ExchangeCoin exchangeCoin = exchangeCoinService.findBySymbol(symbol);
    if (exchangeCoin == null || exchangeCoin.getEnable() != 1) {
        return MessageResult.error(500, msService.getMessage("COIN_FORBIDDEN"));
    }

    // é˜¶æ®µä¸‰ï¼šä»·æ ¼ä¸æ•°é‡ç²¾åº¦å’ŒèŒƒå›´æ ¡éªŒ (å¤§é‡ a.compareTo(b) åˆ¤æ–­)
    // ...

    // é˜¶æ®µå››ï¼šé’±åŒ…çŠ¶æ€æ ¡éªŒ
    MemberWallet baseCoinWallet = walletService.findByCoinUnitAndMemberId(baseCoin, member.getId());
    if (baseCoinWallet.getIsLock() == BooleanEnum.IS_TRUE) {
        return MessageResult.error(500, msService.getMessage("WALLET_LOCKED"));
    }

    // é˜¶æ®µäº”ï¼šç‰¹æ®Šä¸šåŠ¡è§„åˆ™æ ¡éªŒ (å¦‚æŠ¢è´­ã€åˆ†æ‘Šç­‰æ´»åŠ¨é™åˆ¶)
    // ...

    // é˜¶æ®µå…­ï¼šæ„å»ºè®¢å•å¯¹è±¡
    ExchangeOrder order = new ExchangeOrder();
    // ... è®¾ç½®å±æ€§ ...

    // é˜¶æ®µä¸ƒï¼šè°ƒç”¨Serviceå®Œæˆæ ¸å¿ƒä¸šåŠ¡
    MessageResult mr = orderService.addOrder(member.getId(), order);
    if (mr.getCode() != 0) {
        return MessageResult.error(500, "æäº¤è®¢å•å¤±è´¥:" + mr.getMessage());
    }

    // é˜¶æ®µå…«ï¼šå¼‚æ­¥å‘é€æ¶ˆæ¯
    kafkaTemplate.send("exchange-order", JSON.toJSONString(order));

    MessageResult result = MessageResult.success("success");
    result.setData(order.getOrderId());
    return result;
}
```

> **ğŸ’¡ æ¶æ„å¸ˆä¹‹çœ¼ï¼šé‡æ„å»ºè®®**
>
> è™½ç„¶è¿™ç§æ¨¡å¼å°†æ‰€æœ‰é€»è¾‘é›†ä¸­åœ¨ä¸€èµ·ï¼Œä¾¿äºç†è§£å•ä¸ªåŠŸèƒ½çš„æµç¨‹ï¼Œä½†å®ƒä¸¥é‡è¿åäº†â€œ**å…³æ³¨ç‚¹åˆ†ç¦»**â€çš„è®¾è®¡åŸåˆ™ï¼Œå¯¼è‡´ Controller è‡ƒè‚¿ã€éš¾ä»¥ç»´æŠ¤å’Œå•å…ƒæµ‹è¯•ã€‚ä¸€ä¸ªæ›´ä¼˜é›…çš„é‡æ„æ–¹æ¡ˆæ˜¯å°†æ‰€æœ‰æ ¡éªŒé€»è¾‘ä¸‹æ²‰åˆ°ä¸€ä¸ªä¸“é—¨çš„`ValidationService`æˆ–ä½¿ç”¨**ç­–ç•¥æ¨¡å¼**æ¥å¤„ç†ä¸åŒç±»å‹çš„æ ¡éªŒï¼Œè®© Controller å›å½’å…¶è½»è–„çš„æœ¬è´¨â€”â€”**å‚æ•°ç»‘å®šã€è°ƒç”¨æœåŠ¡ã€è§†å›¾/JSON æ¸²æŸ“**ã€‚

#### 2. `ExchangeOrderService`çš„æ ¸å¿ƒä½¿å‘½ï¼šå†»ç»“èµ„é‡‘ä¸æŒä¹…åŒ–è®¢å•

é€šè¿‡äº† Controller çš„å±‚å±‚å…³å¡åï¼Œè¯·æ±‚çš„æ ¸å¿ƒä½¿å‘½ç”±`ExchangeOrderService.addOrder`æ–¹æ³•æ¥å®Œæˆã€‚

**æºç è·¯å¾„: `exchange-core/src/main/java/com/bizzan/bitrade/service/ExchangeOrderService.java`**

```java
@Transactional
public MessageResult addOrder(Long memberId, ExchangeOrder order) {
    // 1. åˆå§‹åŒ–è®¢å•åŸºç¡€ä¿¡æ¯
    order.setTime(Calendar.getInstance().getTimeInMillis());
    order.setStatus(ExchangeOrderStatus.TRADING);
    order.setTradedAmount(BigDecimal.ZERO);
    order.setOrderId(GeneratorUtil.getOrderId("E"));

    // 2. æ ¹æ®äº¤æ˜“æ–¹å‘ï¼Œè®¡ç®—å¹¶å†»ç»“èµ„é‡‘
    if (order.getDirection() == ExchangeOrderDirection.BUY) {
        MemberWallet wallet = memberWalletService.findByCoinUnitAndMemberId(order.getBaseSymbol(), memberId);
        if(wallet.getIsLock().equals(BooleanEnum.IS_TRUE)){
            return MessageResult.error("é’±åŒ…å·²é”å®š");
        }

        // è®¡ç®—éœ€è¦å†»ç»“çš„é‡‘é¢ (turnover)
        BigDecimal turnover;
        if (order.getType() == ExchangeOrderType.MARKET_PRICE) {
            turnover = order.getAmount(); // å¸‚ä»·ä¹°ï¼Œamountä»£è¡¨æˆäº¤é¢
        } else {
            turnover = order.getAmount().multiply(order.getPrice()); // é™ä»·ä¹°ï¼Œæˆäº¤é¢ = æ•°é‡ * ä»·æ ¼
        }

        // ä½™é¢æ ¡éªŒ
        if (wallet.getBalance().compareTo(turnover) < 0) {
            return MessageResult.error(500, "ä½™é¢ä¸è¶³: " + order.getBaseSymbol());
        } else {
            // åŒæ­¥è°ƒç”¨walletæœåŠ¡å†»ç»“èµ„é‡‘
            MessageResult result = memberWalletService.freezeBalance(wallet, turnover);
            if (result.getCode() != 0) {
                // å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘äº‹åŠ¡å›æ»š
                throw new RuntimeException("å†»ç»“ " + order.getBaseSymbol() + " å¤±è´¥");
            }
        }
    } else if (order.getDirection() == ExchangeOrderDirection.SELL) {
        MemberWallet wallet = memberWalletService.findByCoinUnitAndMemberId(order.getCoinSymbol(), memberId);
        if(wallet.getIsLock().equals(BooleanEnum.IS_TRUE)){
            return MessageResult.error("é’±åŒ…å·²é”å®š");
        }

        // ä½™é¢æ ¡éªŒ
        if (wallet.getBalance().compareTo(order.getAmount()) < 0) {
            return MessageResult.error(500, "ä½™é¢ä¸è¶³: " + order.getCoinSymbol());
        } else {
            // åŒæ­¥è°ƒç”¨walletæœåŠ¡å†»ç»“èµ„é‡‘
            MessageResult result = memberWalletService.freezeBalance(wallet, order.getAmount());
            if (result.getCode() != 0) {
                // å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘äº‹åŠ¡å›æ»š
                throw new RuntimeException("å†»ç»“ " + order.getCoinSymbol() + " å¤±è´¥");
            }
        }
    }

    // 3. æŒä¹…åŒ–è®¢å•åˆ°æ•°æ®åº“
    order = exchangeOrderRepository.saveAndFlush(order);

    if (order != null) {
        return MessageResult.success("success");
    } else {
        return MessageResult.error(500, "error");
    }
}
```

è¿™ä¸ªæ–¹æ³•å®Œç¾åœ°è¯ é‡Šäº†â€œ**åŒæ­¥èµ„é‡‘æ“ä½œ**â€çš„æ ¸å¿ƒï¼š

- **`@Transactional`**ï¼šæ•´ä¸ªæ–¹æ³•è¢«ä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡åŒ…è£¹ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ˆç‰¹åˆ«æ˜¯èµ„é‡‘å†»ç»“å¤±è´¥æ—¶ï¼‰æŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€æœ‰å·²å®Œæˆçš„æ•°æ®åº“æ“ä½œéƒ½ä¼šè¢«**å›æ»š**ï¼Œä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§ã€‚
- **ç²¾ç¡®è®¡ç®—**ï¼šä»£ç æ ¹æ®è®¢å•æ˜¯â€œä¹°â€è¿˜æ˜¯â€œå–â€ï¼Œæ˜¯â€œé™ä»·â€è¿˜æ˜¯â€œå¸‚ä»·â€ï¼Œç²¾ç¡®åœ°è®¡ç®—å‡ºéœ€è¦å†»ç»“çš„èµ„é‡‘é‡ã€‚
- **åŒæ­¥è°ƒç”¨**ï¼šé€šè¿‡ Feign å®¢æˆ·ç«¯ï¼ŒåŒæ­¥è°ƒç”¨`wallet`æœåŠ¡çš„`freezeBalance`æ¥å£ã€‚å¦‚æœå†»ç»“å¤±è´¥ï¼Œåˆ™ç«‹å³ä¸­æ–­æµç¨‹ï¼Œè¿”å›é”™è¯¯ã€‚
- **`saveAndFlush()`**ï¼šè¿™ä¸€æ­¥è‡³å…³é‡è¦ã€‚å®ƒä¸ä»…ä»…æ˜¯ä¿å­˜ï¼Œè€Œæ˜¯**ç«‹å³å°†è®¢å•æ•°æ®åˆ·å…¥æ•°æ®åº“**ï¼Œè€Œä¸æ˜¯ç­‰å¾…äº‹åŠ¡æäº¤æ—¶æ‰å†™å…¥ã€‚è¿™ç¡®ä¿äº†åœ¨æ–¹æ³•è¿”å›ã€äº‹åŠ¡å°šæœªå®Œå…¨æäº¤çš„ç¬é—´ï¼Œè®¢å•æ•°æ®åœ¨æ•°æ®åº“ä¸­å·²ç»æ˜¯å¯è§çš„ï¼Œä¸ºåç»­å‘é€ Kafka æ¶ˆæ¯æä¾›äº†åšå®çš„æ•°æ®åŸºç¡€ã€‚

åªæœ‰å½“èµ„é‡‘å†»ç»“å’Œè®¢å•å…¥åº“è¿™ä¸¤ä¸ªæ­¥éª¤éƒ½æˆåŠŸå®Œæˆåï¼Œäº‹åŠ¡æ‰ä¼šæäº¤ï¼Œæ•´ä¸ªåŒæ­¥æ“ä½œæ‰ç®—åœ†æ»¡ã€‚

#### 3. æœ€åçš„å†²åˆºï¼šå¥”å‘ Kafka çš„å¼‚æ­¥æ¶ˆæ¯

å½“`addOrder`æ–¹æ³•æˆåŠŸè¿”å›åï¼Œæ§åˆ¶æƒå›åˆ°`OrderController`ã€‚æ­¤æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œæœ€åä¸€æ­¥ï¼Œä¹Ÿæ˜¯ç”»é¾™ç‚¹ç›çš„ä¸€æ­¥ï¼šå°†è®¢å•ä¿¡æ¯åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²ï¼Œä½œä¸ºä¸€ä¸ªæ¶ˆæ¯ï¼Œå‘é€åˆ°åä¸º`exchange-order`çš„ Kafka ä¸»é¢˜ä¸­ã€‚

è¿™ä¸ªåŠ¨ä½œæ ‡å¿—ç€`exchange-api`ä½¿å‘½çš„ç»“æŸã€‚å®ƒå°†æ’®åˆçš„â€œæ¥åŠ›æ£’â€äº¤ç»™äº†ä¸‹æ¸¸çš„`exchange`æœåŠ¡ï¼Œè‡ªå·±åˆ™å¯ä»¥ç«‹åˆ»å‘ç”¨æˆ·è¿”å›æˆåŠŸçš„å“åº”ï¼Œå‡†å¤‡è¿æ¥ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚

---

## æŸ¥è¯¢ä¾§èŒè´£å‰–æï¼šè®¢å•å†å²ä¸å¸‚åœºæ·±åº¦

é™¤äº†å¤„ç†å‘½ä»¤ï¼Œ`exchange-api`è¿˜æ‰¿æ‹…ç€ä¸ºå‰ç«¯æä¾›æ•°æ®æŸ¥è¯¢çš„é‡ä»»ã€‚

#### 1. è®¢å•å†å²æŸ¥è¯¢ (`/order/history`)

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„**æ•°æ®åº“æŸ¥è¯¢**åœºæ™¯ã€‚å½“ç”¨æˆ·éœ€è¦æŸ¥çœ‹è‡ªå·±çš„å†å²å§”æ‰˜æˆ–å½“å‰æŒ‚å•æ—¶ï¼Œ`exchange-api`ä¼šï¼š

1.  æ¥æ”¶å‰ç«¯çš„è¯·æ±‚ï¼ŒåŒ…å«åˆ†é¡µå‚æ•°ã€äº¤æ˜“å¯¹ã€è®¢å•çŠ¶æ€ç­‰ç­›é€‰æ¡ä»¶ã€‚
2.  è°ƒç”¨`ExchangeOrderService`ä¸­çš„æŸ¥è¯¢æ–¹æ³•ã€‚
3.  Service å±‚ä½¿ç”¨`JPA`æˆ–`MyBatis`ï¼Œæ ¹æ®æ¡ä»¶ä»`exchange_order`è¡¨ä¸­æŸ¥è¯¢å‡ºå¯¹åº”çš„è®¢å•æ•°æ®ã€‚
4.  å°†æŸ¥è¯¢ç»“æœè¿”å›ç»™å‰ç«¯ã€‚

è¿™ä¸ªæµç¨‹ç›¸å¯¹ç®€å•ï¼Œæ˜¯æ ‡å‡†çš„ CRUD æ“ä½œï¼Œè€ƒéªŒçš„æ˜¯æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–å’Œåˆ†é¡µæŸ¥è¯¢çš„æ€§èƒ½ã€‚

#### 2. å¸‚åœºæ·±åº¦æŸ¥è¯¢ (`/market/depth`)

å¸‚åœºæ·±åº¦ï¼Œå³**è®¢å•ç°¿ (Order Book)**ï¼Œæ˜¯äº¤æ˜“ç•Œé¢ä¸Šå®æ—¶è·³åŠ¨çš„ä¹°å–ç›˜ã€‚å¦‚æœæ¯æ¬¡æŸ¥è¯¢éƒ½å»`exchange`æ’®åˆå¼•æ“çš„å†…å­˜ä¸­è·å–ï¼Œä¼šç»™æ’®åˆå¼•æ“å¸¦æ¥å·¨å¤§çš„å‹åŠ›ã€‚å› æ­¤ï¼Œç³»ç»Ÿé‡‡ç”¨äº†ä¸€ç§æ›´é«˜æ•ˆçš„**ç¼“å­˜æœºåˆ¶**ï¼š

1.  **æ•°æ®ç”Ÿäº§è€… (`market`æœåŠ¡)**ï¼š`market`æœåŠ¡ä¼šè®¢é˜…`exchange-trade`å’Œ`exchange-order`ç­‰ Kafka ä¸»é¢˜ï¼Œå®æ—¶åœ°åœ¨å†…å­˜ä¸­æ„å»ºå’Œç»´æŠ¤æ¯ä¸ªäº¤æ˜“å¯¹çš„å®Œæ•´è®¢å•ç°¿ã€‚
2.  **å†™å…¥ç¼“å­˜**ï¼š`market`æœåŠ¡ä¼šå®šæœŸï¼ˆæˆ–åœ¨æ•°æ®å˜åŒ–æ—¶ï¼‰å°†è®¢å•ç°¿çš„å¿«ç…§æ•°æ®ï¼ˆå¦‚ä¹°ä¸€åˆ°ä¹°äº”åï¼Œå–ä¸€åˆ°å–äº”åï¼‰åºåˆ—åŒ–åï¼Œ**å†™å…¥ Redis ç¼“å­˜**ä¸­ã€‚
3.  **æ•°æ®æ¶ˆè´¹è€… (`exchange-api`)**ï¼šå½“ç”¨æˆ·å®¢æˆ·ç«¯éœ€è¦è·å–å¸‚åœºæ·±åº¦æ—¶ï¼Œ`exchange-api`çš„`/market/depth`æ¥å£**ä¸ä¼š**å»è¯·æ±‚ä»»ä½•å…¶ä»–æœåŠ¡ï¼Œè€Œæ˜¯**ç›´æ¥ä» Redis ä¸­è¯»å–**è¿™ä¸ªé¢„å…ˆè®¡ç®—å¥½çš„è®¢å•ç°¿å¿«ç…§ã€‚

è¿™ç§è®¾è®¡ï¼Œå°†è®¡ç®—å‹åŠ›å®Œå…¨ç•™ç»™äº†`market`æœåŠ¡ï¼Œè€Œ`exchange-api`åªåšä¸€ä¸ªè½»é‡çš„ç¼“å­˜è¯»å–æ“ä½œï¼Œä»è€Œèƒ½å¤Ÿä»¥æé«˜çš„æ€§èƒ½ï¼Œæ”¯æ’‘æµ·é‡å®¢æˆ·ç«¯å¯¹å¸‚åœºæ·±åº¦æ•°æ®çš„å¹¶å‘è¯·æ±‚ã€‚

---

## æ¥å£å®‰å…¨åŠ å›ºï¼šé˜²åˆ·ã€é˜²é‡ä¸æœåŠ¡å®¹é”™

å¯¹äºäº¤æ˜“è¿™ç±»æ ¸å¿ƒæ¥å£ï¼Œé™¤äº†ä¸šåŠ¡åŠŸèƒ½çš„å®ç°ï¼Œæ„å»ºä¸€ä¸ªåšå›ºçš„å®‰å…¨å ¡å’åŒæ ·è‡³é‡è¦ã€‚

#### é˜²åˆ·ï¼šé™æµ (Rate Limiting)

æ¶æ„çš„ã€è¶…é«˜é¢‘ç‡çš„ API è¯·æ±‚ä¼šç¬é—´è€—å°½ç³»ç»Ÿèµ„æºã€‚

- **å½“å‰å®ç°**ï¼šæºç ä¸­ä»…æœ‰ä¸€ä¸ª`maxCancelTimes`é…ç½®ï¼Œé™åˆ¶äº†ç”¨æˆ·æ¯æ—¥çš„**æ’¤å•**æ¬¡æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸åˆçº§çš„é˜²åˆ·ç­–ç•¥ã€‚
- **ä¼˜åŒ–å»ºè®®**ï¼šå¼•å…¥åŸºäº**ä»¤ç‰Œæ¡¶ï¼ˆToken Bucketï¼‰**ç®—æ³•çš„é™æµæœºåˆ¶ã€‚å¯ä»¥åˆ©ç”¨`Google Guava`çš„`RateLimiter`åœ¨å•ä½“åº”ç”¨ä¸­å®ç°ï¼Œæˆ–åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œé€šè¿‡`Redis + Lua`è„šæœ¬æ„å»ºä¸€ä¸ªå…¨å±€çš„é™æµå™¨ã€‚é™æµç­–ç•¥åº”åœ¨ API ç½‘å…³å±‚ï¼ˆå¦‚ Nginxï¼‰å’Œä¸šåŠ¡ä»£ç å±‚ï¼ˆé€šè¿‡ AOPï¼‰åŒæ—¶å®æ–½ï¼Œå¯¹ä¸‹å•ã€æ’¤å•ç­‰æ‰€æœ‰æ ¸å¿ƒæ“ä½œè¿›è¡Œç²¾ç»†åŒ–çš„é¢‘ç‡æ§åˆ¶ã€‚

#### é˜²é‡ï¼šå¹‚ç­‰æ€§ (Idempotency)

ç½‘ç»œå»¶è¿Ÿæˆ–å®¢æˆ·ç«¯é‡è¯•ï¼Œå¯èƒ½å¯¼è‡´åŒä¸€ä¸ªä¸‹å•è¯·æ±‚è¢«å‘é€å¤šæ¬¡ï¼Œé€ æˆé‡å¤ä¸‹å•ã€‚

- **å½“å‰å®ç°**ï¼šæºç ä¸­**æ²¡æœ‰**å¤„ç†å¹‚ç­‰æ€§ã€‚
- **ä¼˜åŒ–å»ºè®®**ï¼šå®ç°å¹‚ç­‰æ€§çš„å…³é”®ï¼Œæ˜¯è¦æ±‚å®¢æˆ·ç«¯åœ¨æ¯æ¬¡è¯·æ±‚æ—¶ï¼Œéƒ½ç”Ÿæˆå¹¶æºå¸¦ä¸€ä¸ªå”¯ä¸€çš„è¯·æ±‚ IDï¼ˆ`client_order_id`ï¼‰ã€‚æœåŠ¡ç«¯çš„å¤„ç†é€»è¾‘ç›¸åº”åœ°æ”¹é€ ä¸ºï¼š
  1.  æ¥æ”¶è¯·æ±‚ï¼Œè·å–`client_order_id`ã€‚
  2.  ä½¿ç”¨ Redis çš„`SETNX`ï¼ˆSET if Not eXistsï¼‰æŒ‡ä»¤ï¼Œå°è¯•å°†è¿™ä¸ª ID å†™å…¥ Redisã€‚
  3.  å¦‚æœå†™å…¥æˆåŠŸï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œåˆ™æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚æ‰§è¡Œå®Œæ¯•åï¼Œå¯ä»¥ä¸ºè¿™ä¸ª Redis é”®è®¾ç½®ä¸€ä¸ªåˆç†çš„è¿‡æœŸæ—¶é—´ã€‚
  4.  å¦‚æœå†™å…¥å¤±è´¥ï¼Œè¯´æ˜æ˜¯é‡å¤è¯·æ±‚ï¼Œåˆ™ç›´æ¥æŸ¥è¯¢è¯¥ ID å¯¹åº”çš„åŸå§‹è®¢å•å¤„ç†ç»“æœï¼Œå¹¶è¿”å›ã€‚

#### æœåŠ¡å®¹é”™ï¼šç†”æ–­ä¸é™çº§ (Hystrix)

`exchange-api`åŒæ­¥ä¾èµ–`wallet`æœåŠ¡ï¼Œå¦‚æœ`wallet`æœåŠ¡æ•…éšœæˆ–å“åº”ç¼“æ…¢ï¼Œå°†å¯¼è‡´`exchange-api`çš„çº¿ç¨‹è¢«å…¨éƒ¨é˜»å¡ï¼Œå¼•å‘â€œé›ªå´©æ•ˆåº”â€ã€‚

- **å½“å‰å®ç°**ï¼šåœ¨`WalletServiceFeign`æ¥å£ä¸Šå£°æ˜äº†`fallback = WalletServiceFeignHystrix.class`ã€‚
- **æºç è§£è¯»**ï¼šè¿™æ­£æ˜¯**Hystrix**ç†”æ–­æœºåˆ¶çš„å¨åŠ›æ‰€åœ¨ã€‚
  - **ç†”æ–­ (Circuit Breaker)**ï¼šå½“å¯¹`wallet`æœåŠ¡çš„è°ƒç”¨å¤±è´¥ç‡æˆ–è¶…æ—¶ç‡è¶…è¿‡è®¾å®šçš„é˜ˆå€¼æ—¶ï¼ŒHystrix ä¼šâ€œæ‹‰ä¸‹ç”µé—¸â€ï¼Œåç»­æ‰€æœ‰å¯¹`wallet`æœåŠ¡çš„è¯·æ±‚å°†ä¸å†çœŸæ­£å‘å‡ºï¼Œè€Œæ˜¯ç›´æ¥è¿›å…¥`fallback`æ–¹æ³•ã€‚
  - **é™çº§ (Fallback)**ï¼š`WalletServiceFeignHystrix`ç±»ä¸­çš„å®ç°ï¼Œå°±æ˜¯ä¸€ç§æœåŠ¡é™çº§ã€‚å®ƒä¼šç«‹å³è¿”å›ä¸€ä¸ªé¢„è®¾çš„ã€å‹å¥½çš„é”™è¯¯å“åº”ï¼ˆå¦‚â€œé’±åŒ…æœåŠ¡ç¹å¿™ï¼Œè¯·ç¨åå†è¯•â€ï¼‰ï¼Œè€Œä¸æ˜¯è®©`exchange-api`æ— é™æœŸåœ°ç­‰å¾…æˆ–ç›´æ¥å´©æºƒã€‚è¿™æå¤§åœ°æå‡äº†ç³»ç»Ÿçš„å¥å£®æ€§å’Œç”¨æˆ·ä½“éªŒã€‚

---

## æ€»ç»“ä¸å±•æœ›

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥äº†å¸å¸äº¤æ˜“çš„â€œå‰çº¿æŒ‡æŒ¥å®˜â€â€”â€”`exchange-api`æœåŠ¡ã€‚é€šè¿‡å¯¹ä¸‹å•æµç¨‹çš„æºç çº§è¿½è¸ªï¼Œæˆ‘ä»¬æŒæ¡äº†ä»¥ä¸‹æ ¸å¿ƒè¦ç‚¹ï¼š

- **CQRS æ¶æ„æ€æƒ³**ï¼šæˆ‘ä»¬ç†è§£äº†å°†â€œå‘½ä»¤â€ä¸â€œæŸ¥è¯¢â€åˆ†ç¦»å¸¦æ¥çš„é«˜å¯ç”¨ã€é«˜æ€§èƒ½å’Œæ˜“æ‰©å±•çš„ä¼˜åŠ¿ã€‚
- **â€œèƒ– Controllerâ€çš„åæ€**ï¼šæˆ‘ä»¬è¯†åˆ«äº†è¿™ç§å¸¸è§çš„ä»£ç åå‘³é“ï¼Œå¹¶æ¢è®¨äº†å‘â€œç˜¦ Controllerï¼Œèƒ– Serviceâ€æ¨¡å¼é‡æ„çš„å¿…è¦æ€§ã€‚
- **åŒæ­¥ä¸å¼‚æ­¥çš„åå¥**ï¼šæˆ‘ä»¬å†æ¬¡è§è¯äº†â€œåŒæ­¥èµ„é‡‘æ“ä½œï¼Œå¼‚æ­¥æ’®åˆæŒ‡ä»¤â€è¿™ä¸€è®¾è®¡æ¨¡å¼çš„å¼ºå¤§ï¼Œå®ƒå…¼é¡¾äº†æ•°æ®ä¸€è‡´æ€§ä¸ç³»ç»Ÿå“åº”é€Ÿåº¦ã€‚
- **ç”Ÿäº§çº§å®‰å…¨è®¾è®¡**ï¼šæˆ‘ä»¬æ·±å…¥æ¢è®¨äº†æ¥å£å®‰å…¨çš„ä¸‰å¤§åŸºçŸ³â€”â€”**é˜²åˆ·ï¼ˆé™æµï¼‰ã€é˜²é‡ï¼ˆå¹‚ç­‰æ€§ï¼‰ã€æœåŠ¡å®¹é”™ï¼ˆç†”æ–­é™çº§ï¼‰**ï¼Œè¿™äº›æ˜¯æ„å»ºä»»ä½•é«˜å¯ç”¨ç³»ç»Ÿçš„å¿…å¤‡çŸ¥è¯†ã€‚

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸåœ°å°†ä¸€ç¬”ç»è¿‡ä¸¥æ ¼å®¡æŸ¥çš„äº¤æ˜“æŒ‡ä»¤ï¼Œé€åˆ°äº†æ’®åˆå¼•æ“çš„â€œå¤§é—¨å£â€ã€‚åœ¨ä¸‹ä¸€ç« ï¼Œæˆ‘ä»¬å°†æ¨å¼€è¿™æ‰‡é—¨ï¼Œå»æ¢ç´¢æ•´ä¸ªé¡¹ç›®æŠ€æœ¯å«é‡æœ€é«˜ã€æœ€ç¥ç§˜çš„éƒ¨åˆ†â€”â€”**æ’®åˆå¼•æ“ (`exchange`)**ã€‚æˆ‘ä»¬å°†æ·±å…¥å…¶åŸºäºå†…å­˜çš„æ’®åˆç®—æ³•ï¼Œäº²çœ¼è§è¯ä¹°å–ç›˜æ˜¯å¦‚ä½•åŒ¹é…ï¼Œä¸€ç¬”ç¬”æˆäº¤æ˜¯å¦‚ä½•è¯ç”Ÿçš„ã€‚
